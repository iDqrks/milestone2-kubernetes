apiVersion: apps/v1
kind: Deployment
metadata:
  name: bv-api
  namespace: brent-verlinden
spec:
  replicas: 2
  selector:
    matchLabels:
      app: bv-api
  template:
    metadata:
      labels:
        app: bv-api
    spec:
      containers:
      - name: api
        image: python:3.11-slim
        command: ["/bin/sh"]
        args: 
        - "-c"
        - |
          pip install fastapi uvicorn mysql-connector-python && 
          echo 'from fastapi import FastAPI
          from fastapi.middleware.cors import CORSMiddleware
          import os
          import mysql.connector
          app = FastAPI()
          app.add_middleware(CORSMiddleware, allow_origins=["*"], allow_methods=["*"], allow_headers=["*"])
          
          def get_db_connection():
              return mysql.connector.connect(
                  host="bv-mariadb",
                  user="root",
                  password="password",
                  database="milestone2"
              )
          
          @app.get("/user")
          def get_user():
              try:
                  conn = get_db_connection()
                  cursor = conn.cursor()
                  cursor.execute("SELECT name FROM users WHERE id=1")
                  result = cursor.fetchone()
                  cursor.close()
                  conn.close()
                  return {"name": result[0] if result else "Brent Verlinden"}
              except Exception as e:
                  return {"name": "Brent Verlinden", "error": str(e)}
          
          @app.get("/container")
          def get_container():
              return {"container_id": os.environ.get("HOSTNAME", "unknown"), "service": "brent-api"}
          
          @app.get("/health")
          def health_check():
              return {"status": "healthy"}
          
          import uvicorn
          uvicorn.run(app, host="0.0.0.0", port=8000)' > main.py && 
          python main.py
        ports:
        - containerPort: 8000
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 5
          periodSeconds: 5
