apiVersion: apps/v1
kind: Deployment
metadata:
  name: bv-api
  namespace: brent-verlinden
spec:
  replicas: 2
  selector:
    matchLabels:
      app: bv-api
  template:
    metadata:
      labels:
        app: bv-api
    spec:
      containers:
      - name: api
        image: python:3.11-slim
        ports:
        - containerPort: 8000
        command: ["/bin/sh"]
        args: 
        - -c
        - |
          pip install fastapi uvicorn mysql-connector-python &&
          echo 'from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
import mysql.connector
import os

app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

@app.get("/")
def read_root():
    return {"message": "Brent Verlinden API"}

@app.get("/health")
def health_check():
    return {"status": "healthy"}

@app.get("/data")
def get_data():
    try:
        conn = mysql.connector.connect(
            host="bv-mariadb",
            user="root",
            password="password", 
            database="milestone"
        )
        cursor = conn.cursor()
        cursor.execute("CREATE TABLE IF NOT EXISTS visits (id INT AUTO_INCREMENT PRIMARY KEY, visit_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP)")
        cursor.execute("INSERT INTO visits (visit_time) VALUES (NOW())")
        conn.commit()
        cursor.execute("SELECT * FROM visits")
        results = cursor.fetchall()
        return {"status": "success", "data": results, "container_id": os.uname().nodename}
    except Exception as e:
        return {"status": "error", "message": str(e)}

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
' > app.py && python app.py
